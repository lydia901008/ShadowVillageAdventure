<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å½±å­æ‘èŠå¤§å†’éšª</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;height:100%;font-family:'Noto Sans TC',sans-serif;background:#000}
  .shell{position:fixed;inset:0;display:flex;flex-direction:column}
  header{position:fixed;top:16px;right:16px;z-index:50}
  /* å–®ä¸€å–‡å­æŒ‰éˆ•ï¼ˆçµ±ä¸€æ¨£å¼ï¼‰ */
  .sound-btn{
    width:44px;height:44px;border:none;border-radius:10px;
    background:rgba(255,255,255,.12);backdrop-filter:blur(6px);
    color:#fff;font-size:22px;cursor:pointer;display:grid;place-items:center;
    border:1px solid rgba(255,255,255,.22);
  }
  .sound-btn:focus-visible{outline:2px solid #ffd54f;outline-offset:2px}

  .content{position:fixed;inset:0}
  iframe{position:absolute;inset:0;border:0;width:100%;height:100%;background:#000}
</style>
</head>
<body>
<div class="shell">
  <header>
    <button id="soundBtn" class="sound-btn" aria-label="éŸ³æ•ˆ"><span id="soundIcon">ğŸ”Š</span></button>
  </header>
  <div class="content">
    <iframe id="frame" allow="autoplay"></iframe>
  </div>
</div>

<script>
/* ========= è§£æåˆå§‹åƒæ•¸ï¼š?page=XXX&buddy=...&sprite=... ========= */
const qs = new URLSearchParams(location.search);
const firstPage = qs.get('page') || 'index.html';
const buddy = qs.get('buddy') || '';     // å¯ç©º
const sprite = qs.get('sprite') || '';   // å¯ç©º

/* ========= è¼‰å…¥å­é ï¼ˆæŠŠ buddy/sprite å‚³éçµ¦å­é ï¼‰ ========= */
(function loadChild(){
  const f = document.getElementById('frame');
  const inner = new URLSearchParams();
  if (buddy)  inner.set('buddy', buddy);
  if (sprite) inner.set('sprite', sprite);
  f.src = firstPage + (inner.toString()?`?${inner}`:'');
})();

/* ========= å”¯ä¸€ BGM ç®¡ç†ï¼ˆå…©é¦–ï¼šmain / calmï¼‰ ========= */
(function(){
  const STORE_KEY = 'game_sound_enabled'; // 'off' è¡¨ç¤ºéœéŸ³
  if (!localStorage.getItem(STORE_KEY)) localStorage.setItem(STORE_KEY,'on');

  const tracks = {
    main: new Audio('sounds/bgm_main_cute_joyful.mp3'),
    calm: new Audio('sounds/bgm_calm_daily.mp3')
  };
  Object.values(tracks).forEach(a => { a.loop = true; a.preload = 'auto'; a.volume = 0; });

  let cur = null;        // ç›®å‰åœ¨æ’­çš„ Audio
  let want = 'main';     // æƒ³è¦æ’­æ”¾å“ªä¸€é¦–ï¼ˆç”±å­é é¢è¦æ±‚ï¼‰
  let primed = false;    // æ˜¯å¦å·²è§£é–è‡ªå‹•æ’­æ”¾æ”¿ç­–

  function isOn(){ return localStorage.getItem(STORE_KEY) !== 'off'; }

  function fadeTo(a, target=0.38, ms=300){
    const step = (target - a.volume) / Math.max(1, ms/40);
    const id = setInterval(()=>{
      a.volume = Math.max(0, Math.min(1, a.volume + step));
      const done = (step>0 && a.volume>=target) || (step<0 && a.volume<=target);
      if (done) clearInterval(id);
    }, 40);
  }
  function fadeOutStop(a, ms=220){
    const id = setInterval(()=>{
      a.volume = Math.max(0, a.volume - 1/Math.max(1, ms/40));
      if (a.volume <= 0){ clearInterval(id); a.pause(); }
    }, 40);
  }

  async function ensurePlay(){
    if (!primed){
      try { await tracks[want].play(); } catch(e) {}
      primed = true;
    }
  }
  async function applyTrack(){
    if (!isOn()){
      if (cur) fadeOutStop(cur, 200);
      return;
    }
    const next = tracks[want];
    if (!next) return;
    if (cur === next){
      if (next.paused) { try{ await next.play(); }catch(e){} }
      fadeTo(next, 0.38, 220);
      return;
    }
    if (cur) fadeOutStop(cur, 200);
    try{ await next.play(); }catch(e){}
    fadeTo(next, 0.38, 260);
    cur = next;
  }

  // å–‡å­æŒ‰éˆ•
  const btn = document.getElementById('soundBtn');
  const icon = document.getElementById('soundIcon');
  function refreshIcon(){ if(icon) icon.textContent = isOn() ? 'ğŸ”Š' : 'ğŸ”ˆ'; }
  refreshIcon();
  if (btn){
    btn.addEventListener('click', async ()=>{
      localStorage.setItem(STORE_KEY, isOn() ? 'off' : 'on');
      refreshIcon();
      await ensurePlay();
      applyTrack();
    });
  }

  // é¦–æ¬¡ä½¿ç”¨è€…äº’å‹•å¾Œå•Ÿå‹•æ’­æ”¾
  window.addEventListener('pointerdown', async ()=>{
    await ensurePlay();
    applyTrack();
  }, { once:true });

  // å­é é¢è¨Šæ¯ï¼šåˆ‡æ­Œ / éœéŸ³ / å°èˆª
  window.addEventListener('message', async (e)=>{
    const msg = e.data || {};
    if (msg.type === 'setTrack' && (msg.track === 'main' || msg.track === 'calm')){
      want = msg.track;
      await ensurePlay();
      applyTrack();
    } else if (msg.type === 'toggleMute'){
      localStorage.setItem(STORE_KEY, isOn() ? 'off' : 'on');
      refreshIcon();
      applyTrack();
    } else if (msg.type === 'nav'){
      // {type:'nav', page:'xxx.html', params:{ buddy, sprite }}
      const p = msg.page || 'index.html';
      const params = new URLSearchParams();
      if (msg.params && msg.params.buddy)  params.set('buddy', msg.params.buddy);
      if (msg.params && msg.params.sprite) params.set('sprite', msg.params.sprite);
      navigateTo(p + (params.toString()?`?${params}`:'')); // èµ°çµ±ä¸€æµç¨‹
    }
  });

  // iframe è¼‰å…¥å¾Œï¼Œä¾ç…§è·¯å¾‘è‡ªå‹•æ±ºå®šè¦æ’­å“ªé¦–ï¼ˆä¿éšªï¼‰
  const frame = document.getElementById('frame');
  function pickTrackByPath(p){
    // é è¨­ï¼šmenu/index/dress/find/shadow â†’ mainï¼›move-the-sun â†’ calm
    if (/move-the-sun/i.test(p)) return 'calm';
    return 'main';
  }
  function navigateTo(url){
    frame.src = url;
    // ä¾æ–° URL å…ˆè¡Œåˆ‡æ›æ›²ç›®ï¼ˆä¸ç”¨ç­‰å­é é¢ç™¼è¨Šæ¯ï¼‰
    try{
      const u = new URL(url, location.href);
      want = pickTrackByPath(u.pathname);
      applyTrack();
    }catch(e){}
  }
  if (frame){
    frame.addEventListener('load', ()=>{
      try{
        const url = new URL(frame.src, location.href);
        want = pickTrackByPath(url.pathname);
        applyTrack();
        // åŒæ­¥æŠŠç›®å‰éœéŸ³ç‹€æ…‹å‘Šè¨´å­é é¢ï¼ˆå¯é¸ï¼‰
        frame.contentWindow && frame.contentWindow.postMessage({
          type:'state',
          muted: !isOn()
        }, '*');
      }catch(e){}
    });
  }

  // å…è¨±å¾ç¶²å€åˆ—ç›´æ¥å¸¶ pageï¼Œä¹Ÿé©ç”¨ navigateToï¼ˆå·²å…ˆåœ¨ä¸Šé¢ loadChild è¨­ srcï¼Œä¸€æ¨£æœƒè§¸ç™¼ loadï¼‰
})();
</script>
</body>
</html>
