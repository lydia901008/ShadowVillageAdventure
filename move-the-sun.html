<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Move the Sun</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --brand:#f39c12; --ink:#4b3b2f; --card:#ffffff; --shadow:rgba(0,0,0,.12); }
  *{ box-sizing:border-box }
  body{
    margin:16px; font-family:'Baloo 2', cursive; color:var(--ink);
    background:linear-gradient(120deg,#fff3e0,#e0f7fa);
    display:flex; flex-direction:column; align-items:center;
  }
  header{ width:min(980px,100%); display:flex; justify-content:space-between; align-items:center; gap:12px }
  h1{ margin:8px 0 12px }
  .hud{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .stat{ background:var(--card); border-radius:12px; padding:8px 12px; box-shadow:0 2px 6px var(--shadow) }
  .btn{ appearance:none; border:none; border-radius:12px; background:var(--brand); color:#fff; padding:10px 18px; cursor:pointer; box-shadow:0 3px 8px rgba(243,156,18,.55); font-size:1rem }
  .btn:hover{ background:#e67e22 }

  .stage-wrap{ width:min(980px,100%); }
  .stage{
    position:relative; width:100%; aspect-ratio:16/9; background:#0e2233;
    border-radius:18px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,.18); user-select:none; touch-action:none;
  }
  .bg{ position:absolute; inset:0; background-size:cover; background-position:center; filter:brightness(.97) contrast(1.02) }

  /* 小薄幕避免切場時看到太陽 */
  .curtain{
    position:absolute; inset:0; background:#0b121c; opacity:0; pointer-events:none; transition:opacity .12s ease; z-index:9;
  }
  .curtain.show{ opacity:1; }

  /* 角色區：影子在後面（更自然） */
  .actor-wrap{ position:absolute; left:50%; bottom:12%; transform:translateX(-50%); width:170px; z-index:2; }
  .actor{ position:relative; display:block; width:100%; height:auto; object-fit:contain; z-index:2 }
  .actor-shadow{
    position:absolute; left:50%; bottom:-2px; width:100%;
    transform:translateX(-50%); transform-origin:center bottom;
    opacity:.28; filter:blur(2.2px) grayscale(1) brightness(0.2);
    mix-blend-mode:multiply; z-index:1; pointer-events:none;
  }

  /* 影子方向（左/中/右），使用伸展+傾斜製造方向感 */
  .dir-left  .actor-shadow{ transform:translateX(-60%) skewX(-14deg) rotate(-10deg) scaleX(1.25) scaleY(.68); }
  .dir-center.actor-wrap .actor-shadow{ transform:translateX(-50%) skewX(0deg) rotate(0deg) scaleX(1.0) scaleY(.70); }
  .dir-right .actor-shadow{ transform:translateX(-40%) skewX(14deg) rotate(10deg) scaleX(1.25) scaleY(.68); }

  /* 太陽：上方水平拖曳 + 三個吸附點（左中右），不顯示小點 */
  .rail{ position:absolute; top:20px; left:7%; right:7%; height:0; z-index:4; }
  .sun{
    position:absolute; top:0; width:70px; height:70px; transform:translate(-50%,-50%); border-radius:50%;
    background:radial-gradient(circle at 35% 35%, #fff8b5, #ffe082 45%, #fbc02d 70%, #f39c12 100%);
    box-shadow:0 0 16px rgba(243,156,18,.6), 0 0 30px rgba(243,156,18,.35);
    cursor:grab; z-index:4; opacity:0; transition:opacity .25s ease;
  }
  .sun.drag{ cursor:grabbing }
  .sun.cloak{ opacity:0 !important; transition:none !important; }

  /* 提示：正確位置的虛線框（短暫顯示） */
  .hint-box{
    position:absolute; top:0; transform:translate(-50%,-50%);
    width:76px; height:76px; border-radius:50%;
    border:3px dashed rgba(255,255,255,.9);
    box-shadow:0 0 12px rgba(0,0,0,.22) inset;
    display:none; z-index:3; pointer-events:none;
    animation:hintPulse 1.2s ease;
  }
  @keyframes hintPulse{
    from{ transform:translate(-50%,-50%) scale(.95); opacity:.2 }
    50% { opacity:1 }
    to  { transform:translate(-50%,-50%) scale(1.05); opacity:.2 }
  }

  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; padding:16px; z-index:20 }
  .panel{ background:#fff; border-radius:16px; padding:18px 20px; width:min(560px,92%); box-shadow:0 12px 28px rgba(0,0,0,.25); text-align:center }
  .panel .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px }
  .ghost{ display:none }

  .toast{ position:fixed; left:50%; top:16px; transform:translateX(-50%); background:#fff; border-radius:12px; padding:10px 14px; box-shadow:0 6px 16px rgba(0,0,0,.18); opacity:0; pointer-events:none; z-index:25 }
  .toast.show{ opacity:1; animation:fadeOut 1600ms 600ms forwards }
  @keyframes fadeOut{ to{ opacity:0; transform:translateX(-50%) translateY(-6px) } }

  /* 結尾影片尺寸 */
  .cele-video{ width:100%; max-height:50vh; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.25); }

  @media (max-width:620px){
    .actor-wrap{ width:140px }
    .sun{ width:58px; height:58px }
    .hint-box{ width:64px; height:64px }
  }
</style>
</head>
<body>
  <header>
    <h1>Move the Sun</h1>
    <div class="hud">
      <div class="stat">關卡：<span id="level">1</span>/3</div>
      <div class="stat">成功：<span id="wins">0</span>/1</div>
      <button class="btn" id="hintBtn">提示</button>
      <button class="btn" id="resetBtn">重玩本關</button>
      <button class="btn" id="menuBtn">回到目錄</button>
    </div>
  </header>

  <div class="stage-wrap">
    <div class="stage" id="stage">
      <div class="bg" id="bg"></div>

      <!-- 角色 + 影子（影子在後）-->
      <div class="actor-wrap" id="actorWrap">
        <img id="actor" class="actor" alt="角色">
        <img id="actorShadow" class="actor-shadow" alt="" aria-hidden="true">
      </div>

      <!-- 上方水平軌道（左中右吸附） -->
      <div class="rail" id="rail">
        <div class="hint-box" id="hintBox"></div>
        <div class="sun cloak" id="sun" aria-label="太陽"></div>
      </div>

      <div class="curtain" id="curtain"></div>
    </div>
  </div>

  <div class="overlay" id="startOverlay">
    <div class="panel">
      <h2>把太陽移到正確位置</h2>
      <p>上方拖曳太陽（左／中／右三個位置），讓它符合畫面中「動物與影子」的方向關係。</p>
      <div class="row"><button class="btn" id="startBtn">開始</button></div>
    </div>
  </div>

  <div class="overlay ghost" id="endOverlay">
    <div class="panel">
      <h2>太棒了！</h2>
      <p>你完成所有關卡！</p>
      <!-- 你的慶祝動畫影片 -->
      <video class="cele-video" src="video/good.mp4" autoplay muted playsinline></video>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="playAgainBtn">再玩一次</button>
        <button class="btn" id="goMenuBtn">回到目錄</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  /* ===== 背景關卡 ===== */
  const LEVELS = [
    { bg:'light.jpg'   },
    { bg:'tree.png'    },
    { bg:'village.jpg' }
  ];
  const BG_BASE = 'images/move-sun/';

  /* ===== 角色尺寸表（maxHeight 基準）===== */
  const SIZE_TABLE = [
    {eng:'ant',max:50},{eng:'bear',max:165},{eng:'bird',max:43},{eng:'cat-mother',max:106},
    {eng:'cat',max:87},{eng:'deer',max:136},{eng:'elephant',max:168},{eng:'fox',max:109},
    {eng:'giraffe',max:217},{eng:'lion',max:180},{eng:'rabbit',max:125},{eng:'rhino',max:175},
    {eng:'squirrel',max:57},{eng:'turtle',max:68}
  ];
  function maxHeightFor(name){
    const hit = SIZE_TABLE.find(x=>x.eng===name);
    return hit ? hit.max : 100;
  }

  /* ===== DOM ===== */
  const stage = document.getElementById('stage');
  const curtain = document.getElementById('curtain');
  const bgEl = document.getElementById('bg');
  const rail = document.getElementById('rail');
  const sunEl = document.getElementById('sun');
  const hintBox = document.getElementById('hintBox');
  const actorWrap = document.getElementById('actorWrap');
  const actor = document.getElementById('actor');
  const actorShadow = document.getElementById('actorShadow');

  const levelEl = document.getElementById('level');
  const winsEl = document.getElementById('wins');
  const startOverlay = document.getElementById('startOverlay');
  const endOverlay = document.getElementById('endOverlay');
  const toast = document.getElementById('toast');

  const hintBtn = document.getElementById('hintBtn');
  const resetBtn = document.getElementById('resetBtn');
  const menuBtn = document.getElementById('menuBtn');
  const startBtn = document.getElementById('startBtn');
  const playAgainBtn = document.getElementById('playAgainBtn');
  const goMenuBtn = document.getElementById('goMenuBtn');

  /* ===== 參數：哪隻動物 ===== */
  const qs = new URLSearchParams(location.search);
  const sprite = qs.get('sprite');
  const buddy  = qs.get('buddy') || qs.get('animal') || 'cat';

  // 角色圖片與縮放
  (function setActor(){
    let src = sprite ? decodeURIComponent(sprite) : `images/${buddy}/${buddy}.png`;
    actor.src = src;
    actorShadow.src = src;
    // 依表縮放寬度：把 giraffe=217 作為 180px 寬基準（其他按比例）
    const baseMax = 217;
    const targetW = Math.round(180 * Math.min(1.2, Math.max(0.5, maxHeightFor(buddy)/baseMax)));
    actorWrap.style.width = targetW + 'px';
  })();

  /* ===== 遊戲狀態 ===== */
  const POS_PCTS = [15, 50, 85]; // 左中右吸附點 %
  let level = 1;
  let wins = 0;
  let targetIndex = 1; // 正確太陽位置索引（0/1/2）

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.remove('show'); void toast.offsetWidth;
    toast.classList.add('show');
  }

  /* ===== 影子方向（相反規律）===== */
  // 依「太陽位置索引」決定影子方向：0→right、1→center、2→left
  function shadowDirForSunIndex(sunIndex){
    return sunIndex === 0 ? 'right' : (sunIndex === 2 ? 'left' : 'center');
  }
  function setShadowDirClass(dir){ // 'left'|'center'|'right'
    actorWrap.classList.remove('dir-left','dir-center','dir-right');
    actorWrap.classList.add(`dir-${dir}`);
  }

  /* ===== 薄幕 ===== */
  function withCurtain(task){
    curtain.classList.add('show');
    setTimeout(()=> {
      try{ task(); }finally{
        requestAnimationFrame(()=>requestAnimationFrame(()=> curtain.classList.remove('show')));
      }
    }, 60);
  }

  /* ===== 拖曳太陽（限制水平 + 吸附三點）===== */
  function railRect(){ return rail.getBoundingClientRect(); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function setSunByClientX(clientX){
    const rr = railRect();
    const x = clamp(clientX - rr.left, 0, rr.width);
    const pct = (x / rr.width) * 100;
    sunEl.style.left = `${pct}%`;
    return pct;
  }
  function nearestIndexByPct(pct){
    let idx = 0, best = Infinity;
    POS_PCTS.forEach((p,i)=>{ const d=Math.abs(p-pct); if(d<best){best=d;idx=i;} });
    return idx;
  }
  function makeSunDraggable(){
    let dragging=false;
    function onDown(e){
      dragging = true; sunEl.classList.add('drag');
      setSunByClientX(e.touches?e.touches[0].clientX:e.clientX); e.preventDefault();
    }
    function onMove(e){
      if(!dragging) return;
      setSunByClientX(e.touches?e.touches[0].clientX:e.clientX); e.preventDefault();
    }
    function onUp(e){
      if(!dragging) return;
      dragging=false; sunEl.classList.remove('drag');
      const rr = railRect();
      const cx = (e.changedTouches?e.changedTouches[0].clientX:e.clientX);
      const pct = clamp((cx - rr.left)/rr.width*100, 0, 100);
      const idx = nearestIndexByPct(pct);
      sunEl.style.left = POS_PCTS[idx] + '%';
      checkWin(idx);
    }
    sunEl.addEventListener('mousedown', onDown);
    sunEl.addEventListener('touchstart', onDown, {passive:false});
    window.addEventListener('mousemove', onMove, {passive:false});
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('mouseup', onUp);
    window.addEventListener('touchend', onUp);
  }
  makeSunDraggable();

  /* ===== 關卡 ===== */
  function buildLevel(){
    withCurtain(()=>{
      wins = 0; winsEl.textContent = '0';
      levelEl.textContent = String(level);

      // 背景
      const spec = LEVELS[level-1];
      bgEl.style.backgroundImage = `url(${BG_BASE}${spec.bg})`;

      // 隨機正解：0/1/2
      targetIndex = Math.floor(Math.random()*3);

      // 依正解設定影子方向（相反規律）
      const dir = shadowDirForSunIndex(targetIndex);
      setShadowDirClass(dir);

      // 初始太陽在中間，稍後淡入
      sunEl.classList.add('cloak');
      sunEl.style.left = POS_PCTS[1] + '%';
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        sunEl.classList.remove('cloak');
        sunEl.style.opacity = 1;
      }));

      // 隱藏提示框
      hintBox.style.display = 'none';
    });
  }

  function checkWin(idx){
    if (idx === targetIndex){
      wins = 1; winsEl.textContent = '1';
      try{ new Audio('sounds/found.mp3').play().catch(()=>{}); }catch(e){}
      setTimeout(nextLevel, 650);
    }else{
      showToast('再想想，太陽位置不太對喔！');
    }
  }

  function nextLevel(){
    level++;
    if (level > LEVELS.length){
      endOverlay.classList.remove('ghost');
      // 讓影片自動跑一次即可（已 autoplay, muted, playsinline）
    }else{
      buildLevel();
    }
  }

  /* ===== 提示：在正確太陽位置顯示虛線框 1.2 秒 ===== */
  function showHint(){
    hintBox.style.left = POS_PCTS[targetIndex] + '%';
    hintBox.style.display = 'block';
    hintBox.style.animation = 'none'; void hintBox.offsetWidth; hintBox.style.animation = ''; // 重新觸發動畫
    setTimeout(()=> hintBox.style.display = 'none', 1200);
  }

  /* ===== 導航 ===== */
  function carryParams(url){
    const q = new URLSearchParams();
    if (buddy)  q.set('buddy', buddy);
    if (sprite) q.set('sprite', sprite);
    return `${url}?${q.toString()}`;
  }
  function goMenu(){
    const url = carryParams('games-menu.html');
    if (parent && parent !== window){
      parent.postMessage({type:'nav', page:'games-menu.html', params:{buddy, sprite}}, '*');
    }else{
      location.href = url;
    }
  }

  /* ===== 事件 ===== */
  hintBtn.addEventListener('click', showHint);
  resetBtn.addEventListener('click', buildLevel);
  menuBtn.addEventListener('click', goMenu);
  startBtn.addEventListener('click', ()=>{ startOverlay.classList.add('ghost'); buildLevel(); });
  playAgainBtn.addEventListener('click', ()=>{ endOverlay.classList.add('ghost'); level=1; buildLevel(); });
  goMenuBtn.addEventListener('click', goMenu);

  /* 告知 app-shell：這頁使用 calm 曲子（避免與其他頁同時播放） */
  try{ if (parent && parent !== window){ parent.postMessage({type:'setTrack', track:'calm'}, '*'); } }catch(e){}
</script>
</body>
</html>
